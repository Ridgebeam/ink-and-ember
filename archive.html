<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Scholar's Archive | Kinship Portal</title>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,700;1,400&display=swap');

    :root {
      --gold: #c5a059; --gold-dim: #8b6d31; --gold-glow: rgba(197, 160, 89, 0.4);
      --bg-dark: #0a0c10; --panel-bg: rgba(10, 12, 16, 0.95); --stone-border: #1a1a1a;
      --accent: var(--gold);
      --war-purple: #9f7aea;
      --rarity-legendary: #ff8000; --rarity-incomp: #0070dd; --rarity-rare: #a335ee;
    }

    /* THEMES */
    body.theme-minas-tirith { --accent: #e0e0e0; --bg-dark: #1a202c; }
    body.theme-moria { --accent: #4fd1c5; --bg-dark: #0d1117; }
    body.theme-mirkwood { --accent: #48bb78; --bg-dark: #060906; }
    body.theme-isengard { --accent: #cbd5e0; --bg-dark: #000000; }
    body.theme-lorien { --accent: #f6e05e; --bg-dark: #1c1917; }
    body.theme-angmar { --accent: #9f7aea; --bg-dark: #0f0514; }
    body.theme-shire { --accent: #ed8936; --bg-dark: #1a1c0e; }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: var(--bg-dark) url('https://wallpaperaccess.com/full/223243.jpg') no-repeat center center fixed;
      background-size: cover; font-family: 'Crimson Text', serif; color: #e4d5b7; line-height: 1.6;
      transition: all 0.4s ease;
    }
    body::before { content: ""; position: fixed; inset: 0; background: radial-gradient(circle, transparent 20%, var(--bg-dark) 95%); z-index: -1; }

    .middle-earth {
      max-width: 1100px; margin: 40px auto; background: var(--panel-bg); border: 4px solid var(--stone-border);
      outline: 1px solid var(--accent); outline-offset: -12px; box-shadow: 0 0 60px rgba(0,0,0,0.9); padding: 40px; backdrop-filter: blur(10px);
    }

    body.shared-mode .edit-only { display: none !important; }

    header { text-align: center; border-bottom: 2px solid var(--accent); margin-bottom: 30px; }
    .top-banner { width: 100%; height: 300px; object-fit: cover; border-bottom: 2px solid var(--accent); }

    h1 {
      font-family: 'Cinzel'; font-size: 3.2rem; color: var(--accent); letter-spacing: 4px;
      text-shadow: 2px 2px 4px #000; position: relative; margin-top: -60px; 
      background: var(--panel-bg); display: inline-block; padding: 10px 30px; border: 1px solid var(--gold-dim);
    }

    .hero-banner { display: flex; align-items: center; gap: 25px; background: rgba(0,0,0,0.5); border: 1px solid var(--gold-dim); padding: 20px; margin-bottom: 30px; }
    .portrait { width: 120px; height: 120px; border: 2px solid var(--accent); object-fit: cover; }
    
    .status-badge { font-family: 'Cinzel'; font-size: 0.75rem; color: var(--accent); background: rgba(0,0,0,0.4); padding: 4px 12px; border: 1px solid var(--gold-dim); display: inline-block; margin-top: 8px; letter-spacing: 1px; }

    .vital-track { display: flex; gap: 10px; margin-top: 10px; }
    .vital-box { flex: 1; border: 1px solid #333; padding: 2px 8px; font-size: 0.7rem; display: flex; justify-content: space-between; align-items: center; }
    .vital-box.morale { border-left: 3px solid #e53e3e; background: rgba(229, 62, 62, 0.1); }
    .vital-box.power { border-left: 3px solid #3182ce; background: rgba(49, 130, 206, 0.1); }

    .armory-container { display: grid; grid-template-columns: 200px 1fr; border-top: 1px solid var(--gold-dim); padding-top: 20px; }
    .side-nav { display: flex; flex-direction: column; gap: 5px; border-right: 1px solid #333; padding-right: 15px; }
    .panel { display: none; padding: 0 20px; max-height: 80vh; overflow-y: auto; }
    .panel.active { display: block; animation: fadeIn 0.3s ease; }

    .btn { background: linear-gradient(to bottom, var(--accent), var(--gold-dim)); color: #000; border: 1px solid #000; padding: 10px 15px; font-family: 'Cinzel'; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; }
    .btn:hover { filter: brightness(1.2); }
    
    .nav-link { background: transparent; color: var(--accent); border: none; text-align: left; padding: 12px; font-family: 'Cinzel'; cursor: pointer; border-left: 2px solid transparent; }
    .nav-link.active { border-left: 2px solid var(--accent); background: rgba(255,255,255,0.05); color: white; }

    input, textarea, select { width: 100%; padding: 10px; background: #000; border: 1px solid var(--gold-dim); color: var(--accent); font-family: inherit; margin-bottom: 10px; }
    .read-only-text { background: rgba(0,0,0,0.2); border: 1px solid #333; padding: 15px; color: #e4d5b7; min-height: 80px; white-space: pre-wrap; }
    
    .stat-category { margin-bottom: 20px; border: 1px solid var(--gold-dim); padding: 10px; background: rgba(0,0,0,0.2); }
    .stat-category h4 { font-family: 'Cinzel'; color: var(--accent); margin-bottom: 10px; border-bottom: 1px solid #444; font-size: 0.9rem; }
    .stat-row { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 5px 10px; margin-bottom: 4px; border: 1px solid #333; font-size: 0.9rem; }
    .stat-input-small { width: 80px; text-align: center; background: #000; color: var(--accent); border: 1px solid var(--gold-dim); font-weight: bold; padding: 2px; margin: 0 5px; }
    .btn-small { background: var(--accent); color: black; border: none; width: 22px; height: 22px; cursor: pointer; font-weight:bold; }

    .grid-display { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .item-card { background: rgba(255,255,255,0.05); padding: 12px; border: 1px solid #333; border-left: 4px solid var(--accent); position: relative; }
    .item-card.legendary { border-left-color: var(--rarity-legendary); box-shadow: inset 0 0 10px rgba(255, 128, 0, 0.1); }
    .item-card.incomparable { border-left-color: var(--rarity-incomp); }
    .duty-tag { display: inline-block; background: rgba(255,255,255,0.1); border: 1px solid var(--gold-dim); color: var(--accent); padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; margin: 2px; }

    .medal-wall { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid #333; }
    .medal { width: 50px; height: 50px; background: #000; border: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; filter: grayscale(1); opacity: 0.3; transition: 0.3s; cursor: pointer; }
    .medal.active { filter: grayscale(0); opacity: 1; border-color: var(--accent); box-shadow: 0 0 10px var(--gold-glow); }
    .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; }
    .gallery-img { width: 100%; height: 120px; object-fit: cover; border: 1px solid #444; }

    #save-toast { position: fixed; bottom: 30px; right: 30px; background: #1a1a1a; border: 1px solid var(--accent); color: var(--accent); font-family: 'Cinzel'; font-size: 0.75rem; padding: 12px 24px; opacity: 0; pointer-events: none; transition: 0.4s ease; z-index: 9999; box-shadow: 0 0 15px rgba(0,0,0,0.8); letter-spacing: 1px; }
    #save-toast.show { opacity: 1; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    #modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:100; align-items:center; justify-content:center; }
    .modal-box { background:#1a1a1a; padding:30px; width:90%; max-width:750px; border:1px solid var(--accent); box-shadow: 0 0 30px rgba(0,0,0,1); }
    
    /* READER MODE: Transform the App into a Manuscript */
    body.reader-mode .side-nav, 
    body.reader-mode .edit-only, 
    body.reader-mode .nav-link,
    body.reader-mode .btn,
    body.reader-mode header h1,
    body.reader-mode #save-toast { display: none !important; }

    body.reader-mode .middle-earth {
      max-width: 850px;
      margin: 20px auto;
      border: none;
      box-shadow: none;
      background: url('https://www.transparenttextures.com/patterns/parchment.png'), #f4e4bc;
      color: #2a1b0a;
      padding: 60px;
      outline: 2px solid #2a1b0a;
      outline-offset: -20px;
    }

    body.reader-mode .armory-container { display: block; border: none; }
    body.reader-mode .panel { display: block !important; margin-bottom: 40px; opacity: 1; border-bottom: 1px dotted #2a1b0a; padding-bottom: 20px;}
    body.reader-mode .read-only-text { background: transparent; border-left: 2px solid #2a1b0a; color: #2a1b0a; display: block !important; }
    body.reader-mode h3 { border-bottom: 1px solid #2a1b0a; padding-bottom: 5px; margin-top: 30px; color: #2a1b0a; font-family: 'Cinzel'; }
    body.reader-mode .stat-category { border: 1px solid #2a1b0a; background: rgba(0,0,0,0.05); }
    body.reader-mode .stat-row { background: transparent; border-bottom: 1px solid rgba(0,0,0,0.1); color: #2a1b0a; }
  </style>
</head>
<body onclick="initAudioContext()"> <div id="save-toast">‚úíÔ∏è Ledger Updated</div>

<div class="middle-earth">
  <header>
    <img src="https://imgur.com/iAEONaH.jpeg" class="top-banner">
    <h1>The Scholar's Archive</h1>
  </header>

  <section class="hero-banner">
    <img id="main-portrait" src="https://via.placeholder.com/120" class="portrait">
    <div style="flex:1">
      <h2 id="main-name" style="font-family:'Cinzel'; color:var(--accent);">Loading...</h2>
      <h4 id="main-title" style="font-family:'Cinzel'; color:#888; text-transform:uppercase; letter-spacing:1px; font-size:0.8rem;">Citizen</h4>
      <div id="main-status" class="status-badge">Awaiting Orders...</div>
      <p id="main-meta" style="font-style:italic; font-size: 0.85rem; margin-top:5px;">Updating...</p>
      
      <div class="vital-track">
        <div class="vital-box morale">‚ù§Ô∏è <span id="val-morale">0</span></div>
        <div class="vital-box power">üíß <span id="val-power">0</span></div>
      </div>

      <div id="main-stats-preview" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; font-size:0.7rem; color: #aaa;"></div>
    </div>
    <div style="display:flex; flex-direction:column; gap:5px;">
      <button class="btn edit-only" onclick="generateDiscordCard()">üì¢ Character Dossier</button>
      <button class="btn edit-only" style="background: var(--war-purple); color: white;" onclick="prepareVisualArtifact()">‚ú® Render Artifact</button>
      <button class="btn edit-only" onclick="generateShareLink()">üîó Share Journal</button>
      <button id="exit-shared" class="btn" style="display:none; background:#600; color:white;" onclick="window.location.href=window.location.pathname">üö™ Exit View</button>
    </div>
  </section>

  <div class="armory-container">
    <nav class="side-nav">
      <button class="nav-link active" onclick="showPanel('profile', this)">üë§ Identity</button>
      <button class="nav-link" onclick="showPanel('stats-panel', this)">‚öîÔ∏è Attributes</button>
      <button class="nav-link" onclick="showPanel('war-panel', this)">üõ°Ô∏è The War</button>
      <button class="nav-link" onclick="showPanel('role', this)">üìú Hierarchy</button>
      <button class="nav-link" onclick="showPanel('missions', this)">üèπ Missions</button>
      <button class="nav-link" onclick="showPanel('vault', this)">üì¶ Armory</button>
      <button class="nav-link" onclick="showPanel('kinship', this)">ü§ù Kinship</button>
      <button class="nav-link" onclick="showPanel('chronicle', this)">üñãÔ∏è Chronicle</button>
      <button class="nav-link" onclick="showPanel('gallery', this)">üñºÔ∏è Gallery</button>
      <button class="nav-link" onclick="showPanel('technical', this)">‚öôÔ∏è Technical</button>
      <button class="nav-link edit-only" onclick="showPanel('settings', this)">üõ†Ô∏è Settings</button>
    </nav>

    <main id="app-viewport">
      <section id="profile" class="panel active">
        <h3 style="font-family:'Cinzel'; margin-bottom:10px;">Identity</h3>
        <div class="edit-only">
          <input type="text" id="in-name" placeholder="Character Name" onchange="updateChar('name', this.value)">
          <input type="text" id="in-fulltitle" placeholder="Full Honorific Title" onchange="updateChar('fullTitle', this.value)">
          <input type="text" id="in-status" placeholder="Current Location/Status" onchange="updateChar('status', this.value)">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <input type="text" id="in-race" placeholder="Race" onchange="updateChar('race', this.value)">
            <input type="text" id="in-class" placeholder="Class" onchange="updateChar('class', this.value)">
            <input type="number" id="in-lvl" placeholder="Level" onchange="updateChar('level', this.value)">
            <select id="in-playstyle" onchange="updateChar('playstyle', this.value)">
                <option value="RP'er">RP'er</option>
                <option value="Crafter">Crafter</option>
                <option value="Fighter">Fighter</option>
            </select>
            <input type="number" id="in-morale" placeholder="Max Morale" onchange="updateChar('morale', this.value)">
            <input type="number" id="in-power" placeholder="Max Power" onchange="updateChar('power', this.value)">
          </div>
          <input type="text" id="in-mount" placeholder="Horse / Mount Name" onchange="updateChar('mount', this.value)">
          <input type="text" id="in-address" placeholder="House Address" onchange="updateChar('address', this.value)">
          <input type="text" id="in-img" placeholder="Portrait URL" onchange="updateChar('img', this.value)">
          <textarea id="in-bio" placeholder="Personal Backstory..." rows="6" onchange="updateChar('bio', this.value)"></textarea>
        </div>
        <div id="view-profile" class="read-only-text" style="display:none;"></div>
        
        <h4 style="font-family:'Cinzel'; color:var(--accent); margin-top:20px;">Slotted Virtues</h4>
        <div id="virtue-wall" class="medal-wall"></div>
      </section>

      <section id="stats-panel" class="panel">
        <h3 style="font-family:'Cinzel'; margin-bottom:10px;">Combat Attributes</h3>
        <div id="stats-editor"></div>
      </section>

      <section id="war-panel" class="panel">
        <h3 style="font-family:'Cinzel'; margin-bottom:10px;">The War (PvMP)</h3>
        <div class="edit-only">
            <label style="font-size:0.8rem; color:var(--war-purple)">Military Rank:</label>
            <select id="in-war-rank" onchange="updateWar('rank', this.value)">
                <option value="None">No Rank</option>
                <option value="Footman (R1)">Footman (Rank 1)</option>
                <option value="Esquire (R2)">Esquire (Rank 2)</option>
                <option value="Guardsman (R3)">Guardsman (Rank 3)</option>
                <option value="Man-at-Arms (R4)">Man-at-Arms (Rank 4)</option>
                <option value="Sergeant-at-Arms (R5)">Sergeant-at-Arms (Rank 5)</option>
                <option value="Master Guardsman (R6)">Master Guardsman (Rank 6)</option>
                <option value="Master-at-Arms (R7)">Master-at-Arms (Rank 7)</option>
                <option value="High Warden (R8)">High Warden (Rank 8)</option>
                <option value="Lieutenant (R9)">Lieutenant (Rank 9)</option>
                <option value="Commander (R10)">Commander (Rank 10)</option>
                <option value="Third Marshall (R11)">Third Marshall (Rank 11)</option>
                <option value="Second Marshall (R12)">Second Marshall (Rank 12)</option>
                <option value="First Marshall (R13)">First Marshall (Rank 13)</option>
                <option value="Captain-General (R14/15)">Captain-General (Rank 14/15)</option>
            </select>
            <input type="number" id="in-war-points" placeholder="Total Renown" onchange="updateWar('points', this.value)">
            <input type="number" id="in-war-comm" placeholder="Commendations" onchange="updateWar('commendations', this.value)">
        </div>
        <div id="view-war" class="read-only-text" style="display:none; border-left: 4px solid var(--war-purple);"></div>
        
        <h4 style="font-family:'Cinzel'; color:var(--accent); margin-top:20px;">Hall of Valor</h4>
        <div id="medal-wall" class="medal-wall"></div>
      </section>

      <section id="role" class="panel">
        <h3 style="font-family:'Cinzel';">Hierarchy</h3>
        <div class="edit-only">
          <select id="in-hierarchy" onchange="updateRole('hierarchy', this.value)">
            <option value="Recruit">Recruit</option>
            <option value="Member">Member</option>
            <option value="Officer">Officer</option>
            <option value="Founder/Leader">Founder/Leader</option>
          </select>
          <input type="text" id="in-role-title" placeholder="Special Rank Title" onchange="updateRole('title', this.value)">
        </div>
        <div id="view-hierarchy" class="read-only-text" style="display:none; margin-bottom:10px;"></div>
        <div style="background:rgba(0,0,0,0.3); padding:15px; border:1px solid var(--gold-dim);">
          <h4 style="font-family:'Cinzel'; color:var(--accent);">Active Duties</h4>
          <div id="duty-list"></div>
          <div class="edit-only" style="display:flex; gap:5px; margin-top:10px;">
            <input type="text" id="new-duty" placeholder="Add duty...">
            <button class="btn" onclick="addDuty()">Add</button>
          </div>
        </div>
      </section>

      <section id="missions" class="panel">
        <h3 style="font-family:'Cinzel';">Missions</h3>
        <div id="mission-list" class="grid-display"></div>
        <div class="edit-only">
          <input type="text" id="m-title" placeholder="Mission Name">
          <select id="m-status"><option value="OPEN">OPEN</option><option value="CLOSED">CLOSED</option></select>
          <textarea id="m-desc" placeholder="Briefing details..."></textarea>
          <button class="btn" onclick="addMission()">Post</button>
        </div>
      </section>

      <section id="vault" class="panel">
        <h3 style="font-family:'Cinzel';">Vault</h3>
        <div id="vault-list" class="grid-display"></div>
        <div class="edit-only">
          <input type="text" id="v-name" placeholder="Item Name">
          <input type="text" id="v-stats" placeholder="Stats (e.g. +50 Agi)">
          <select id="v-rarity">
            <option value="common">Common</option>
            <option value="rare">Rare (Purple)</option>
            <option value="incomparable">Incomparable (Teal)</option>
            <option value="legendary">Legendary (Gold)</option>
          </select>
          <button class="btn" onclick="addItem()">Store Item</button>
        </div>
      </section>

      <section id="kinship" class="panel">
        <h3 style="font-family:'Cinzel';">Allies</h3>
        <div id="kin-list" class="grid-display"></div>
        <div class="edit-only">
          <input type="text" id="k-name" placeholder="Ally Name">
          <input type="text" id="k-role" placeholder="Role/Relationship">
          <button class="btn" onclick="addKin()">Add</button>
        </div>
      </section>

      <section id="chronicle" class="panel">
        <h3 style="font-family:'Cinzel';">Logs</h3>
        <div id="chron-list"></div>
        <div class="edit-only">
          <select id="c-type"><option value="üìú LORE">LORE</option><option value="‚öîÔ∏è QUEST">QUEST</option></select>
          <textarea id="c-text" rows="3" placeholder="Entry text..."></textarea>
          <button class="btn" onclick="addChronicle()">Log</button>
        </div>
      </section>

      <section id="gallery" class="panel">
        <h3 style="font-family:'Cinzel';">Screenshots</h3>
        <div class="edit-only" style="display:flex; gap:5px; margin-bottom:15px;">
            <input type="text" id="g-url" placeholder="Paste Imgur/Discord Image Link">
            <button class="btn" onclick="addGalleryImg()">Add</button>
        </div>
        <div id="gallery-display" class="gallery-grid"></div>
      </section>

      <section id="technical" class="panel">
        <h3 style="font-family:'Cinzel';">Technical Records</h3>
        <div class="edit-only">
            <textarea id="in-plugins" placeholder="Active Plugins List..." rows="4" onchange="updateChar('plugins', this.value)"></textarea>
            <textarea id="in-ui" placeholder="UI layout export strings..." rows="4" style="font-family:monospace; font-size:0.7rem;" onchange="updateChar('uiLayouts', this.value)"></textarea>
            <input type="text" id="in-map" placeholder="Cartography Map URL..." onchange="updateChar('mapUrl', this.value)">
        </div>
        <iframe id="map-frame" src="" style="width:100%; height:400px; border:1px solid var(--accent); background:#000;"></iframe>
      </section>

      <section id="settings" class="panel edit-only">
        <h3 style="font-family:'Cinzel';">Archive Management</h3>
        <select id="theme-selector" onchange="updateTheme(this.value)">
          <option value="default">Classic</option>
          <option value="theme-minas-tirith">Gondor</option>
          <option value="theme-moria">Moria</option>
          <option value="theme-mirkwood">Mirkwood</option>
          <option value="theme-isengard">Isengard</option>
          <option value="theme-lorien">Lothl√≥rien</option>
          <option value="theme-angmar">Angmar</option>
          <option value="theme-shire">Shire</option>
        </select>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn" style="flex:1" onclick="exportData()">üíæ Export JSON</button>
            <button class="btn" style="flex:1" onclick="document.getElementById('import-file').click()">üìÇ Import JSON</button>
            <input type="file" id="import-file" style="display:none" onchange="importData(event)">
        </div>
        <button class="btn" style="width:100%; margin-top:10px; background: #600; color: white;" onclick="resetData()">üö® Wipe Local Archive</button>
      </section>
    </main>
  </div>
</div>

<div id="modal">
    <div class="modal-box">
        <h3 id="modal-title" style="font-family:'Cinzel'; color:var(--accent);">üì¢ Output</h3>
        <p id="modal-sub" style="font-size:0.75rem; color:#888; margin-bottom:10px;"></p>
        <textarea id="discord-out" style="height:400px; width:100%; font-family: monospace; font-size: 0.8rem; color: #fff; background: #000; padding: 10px; border:1px solid #333;"></textarea>
        <div style="display:flex; gap:10px; margin-top: 15px;">
            <button class="btn" style="flex:2" onclick="copyDiscordCard()">Copy</button>
            <button class="btn" style="flex:1" onclick="closeModal()">Close</button>
        </div>
    </div>
</div>

<script>
  const DB_KEY = 'scholar_ledger_v11';
  let isSharedView = false;
  let audioCtx = null;

  function initAudioContext() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
  }

  function playClickSound() {
    const soundURL = 'https://static.wixstatic.com/mp3/27bdae_d39df76a7044438fb650577244adfdfa.wav';
    const audio = new Audio(soundURL);
    audio.volume = 0.2;
    audio.play().catch(e => console.log("Audio blocked: click page first."));
  }

  document.addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON' || e.target.classList.contains('nav-link')) {
      playClickSound();
    }
  });

  const statStructure = {
    "Core": ["MGT", "AGI", "VIT", "WIL", "FAT"],
    "Offence": ["Critical Rating", "Finesse", "Physical Mastery", "Tactical Mastery"],
    "Defence": ["Light of Earendil", "Resistance", "Critical Defence", "Incoming Healing"],
    "Avoidance": ["Block", "Parry", "Evade"],
    "Mitigations": ["Melee", "Ranged", "Tactical"],
    "Damage Type": ["Physical", "Tactical Dmg"]
  };

  const medals = [
    {id: 'm1', icon: '‚öîÔ∏è', label: 'Veteran'}, {id: 'm2', icon: 'üêâ', label: 'Slayer'},
    {id: 'm3', icon: 'üõ°Ô∏è', label: 'Defender'}, {id: 'm4', icon: 'üèîÔ∏è', label: 'Explorer'}
  ];
  const virtues = ["Valour", "Zeal", "Confidence", "Honour", "Loyalty", "Determination", "Justice"];

  let data = {
    profile: { name: "New Hero", fullTitle: "The Unnamed", race: "Race", class: "Class", level: 1, img: "", bio: "", theme: "default", status: "Resting", address: "None", playstyle: "RP'er", mount: "None", mapUrl: "", plugins: "", uiLayouts: "", morale: 0, power: 0 },
    war: { rank: "None", points: 0, commendations: 0, medals: [] },
    role: { title: "Citizen", hierarchy: "Member", duties: [] },
    stats: {}, virtues: [], gallery: [],
    vault: [], kinship: [], chronicle: [], missions: []
  };

  Object.values(statStructure).flat().forEach(s => data.stats[s] = 0);

  function init() {
    const params = new URLSearchParams(window.location.search);
    const shared = params.get('view');
    const mode = params.get('mode');

    if (shared) {
      try { 
        data = JSON.parse(atob(decodeURIComponent(shared))); 
        isSharedView = true; 
        document.body.classList.add('shared-mode'); 
        if (mode === 'display') document.body.classList.add('reader-mode');
      } catch(e) { console.error("Link failed"); }
    } else {
      const local = localStorage.getItem(DB_KEY); if (local) data = JSON.parse(local);
    }
    render();
  }

  function render() {
    const p = data.profile; const r = data.role; const w = data.war || {rank:"None", points:0, commendations:0, medals: []};
    document.getElementById('main-name').innerText = (p.name || "UNNAMED").toUpperCase();
    document.getElementById('main-title').innerText = `${r.hierarchy} | ${r.title}`;
    document.getElementById('main-status').innerText = "üìç " + (p.status || "Resting");
    document.getElementById('main-meta').innerText = `${p.race} ${p.class} | Lv ${p.level}`;
    document.getElementById('main-portrait').src = p.img || "https://via.placeholder.com/120";
    document.getElementById('val-morale').innerText = p.morale || 0;
    document.getElementById('val-power').innerText = p.power || 0;
    document.body.className = p.theme || 'default';
    
    if (!isSharedView) {
      document.getElementById('in-name').value = p.name;
      document.getElementById('in-fulltitle').value = p.fullTitle;
      document.getElementById('in-status').value = p.status;
      document.getElementById('in-race').value = p.race;
      document.getElementById('in-class').value = p.class;
      document.getElementById('in-lvl').value = p.level;
      document.getElementById('in-morale').value = p.morale;
      document.getElementById('in-power').value = p.power;
      document.getElementById('in-mount').value = p.mount;
      document.getElementById('in-address').value = p.address;
      document.getElementById('in-img').value = p.img;
      document.getElementById('in-bio').value = p.bio;
      document.getElementById('in-war-rank').value = w.rank;
      document.getElementById('in-war-points').value = w.points;
      document.getElementById('in-war-comm').value = w.commendations;
      document.getElementById('in-hierarchy').value = r.hierarchy;
      document.getElementById('in-role-title').value = r.title;
      document.getElementById('in-plugins').value = p.plugins || "";
      document.getElementById('in-ui').value = p.uiLayouts || "";
      document.getElementById('in-map').value = p.mapUrl || "";
    } else {
      document.getElementById('view-profile').innerText = `TITLE: ${p.fullTitle}\nMOUNT: ${p.mount}\nHOME: ${p.address}\n\n${p.bio}`;
      document.getElementById('view-profile').style.display = 'block';
      document.getElementById('view-war').style.display = 'block';
      document.getElementById('view-war').innerText = `MILITARY RANK: ${w.rank}\nRENOWN/INFAMY: ${w.points}\nCOMMENDATIONS: ${w.commendations}`;
    }

    let statHTML = "";
    for (const [cat, keys] of Object.entries(statStructure)) {
      statHTML += `<div class="stat-category"><h4>${cat}</h4>`;
      keys.forEach(k => {
        const val = data.stats[k] || 0;
        statHTML += `<div class="stat-row"><span>${k}</span><div>${!isSharedView ? `<button class="btn-small" onclick="modStat('${k}',-10)">-</button>` : ''}<input type="number" class="stat-input-small" value="${val}" onchange="directUpdateStat('${k}', this.value)">${!isSharedView ? `<button class="btn-small" onclick="modStat('${k}',10)">+</button>` : ''}</div></div>`;
      });
      statHTML += `</div>`;
    }
    document.getElementById('stats-editor').innerHTML = statHTML;
    document.getElementById('main-stats-preview').innerHTML = ["MGT", "AGI", "VIT", "WIL", "FAT"].map(s => `<span><strong>${s}:</strong> ${data.stats[s] || 0}</span>`).join(' ') + ` <span style="color:var(--war-purple)"><strong>Rank:</strong> ${w.rank}</span>`;

    document.getElementById('medal-wall').innerHTML = medals.map(m => `<div class="medal ${data.war.medals?.includes(m.id) ? 'active' : ''}" onclick="toggleMedal('${m.id}')">${m.icon}</div>`).join('');
    document.getElementById('virtue-wall').innerHTML = virtues.map(v => `<div class="medal ${data.virtues?.includes(v) ? 'active' : ''}" onclick="toggleVirtue('${v}')">üìú</div>`).join('');
    document.getElementById('gallery-display').innerHTML = (data.gallery || []).map(url => `<img src="${url}" class="gallery-img">`).join('');
    document.getElementById('duty-list').innerHTML = (r.duties || []).map(d => `<span class="duty-tag">${d}</span>`).join('');
    document.getElementById('mission-list').innerHTML = (data.missions || []).map(m => `<div class="item-card"><strong>${m.t}</strong><br><small>${m.d}</small></div>`).join('');
    
    document.getElementById('vault-list').innerHTML = data.vault.map(i => `<div class="item-card ${i.r || ''}"><strong>${i.n}</strong><br><small>${i.s}</small></div>`).join('');
    document.getElementById('kin-list').innerHTML = data.kinship.map(k => `<div class="item-card"><strong>${k.n}</strong><br><small>${k.r}</small></div>`).join('');
    document.getElementById('chron-list').innerHTML = data.chronicle.map(c => `<div style="border-bottom:1px solid #333; padding:5px 0;"><small>${c.d} | ${c.type || 'LORE'}</small><p>${c.t}</p></div>`).join('');
    document.getElementById('map-frame').src = p.mapUrl || "";
  }

  function generateDiscordCard() {
    const p = data.profile; const r = data.role; const s = data.stats;
    const getBar = (val) => { 
      const num = parseInt(val) || 0; 
      const filled = Math.min(5, Math.max(0, Math.floor(num / 20))); 
      return "‚ñ†".repeat(filled) + "‚ñ°".repeat(5 - filled); 
    };
    const historySnippet = p.bio ? p.bio.substring(0, 300).replace(/\n/g, ' ') + (p.bio.length > 300 ? '...' : '') : 'A tale yet to be told...';
    const dutiesList = (r.duties && r.duties.length > 0) ? r.duties.map(d => `[1;34m‚ÅÉ[0m [1;37m${d}[0m`).join('\n') : "[1;30m‚ÅÉ No duties assigned.[0m";
    const activeMissions = data.missions ? data.missions.filter(m => m.s === 'OPEN') : [];
    const missionsList = (activeMissions.length > 0) ? activeMissions.slice(0, 3).map(m => `[1;34m‚ÅÉ[0m [1;37m${m.t}[0m`).join('\n') : "[1;30m‚ÅÉ No active missions.[0m";

    const card = `[‚Äã‚Äã‚Äã‚Äã‚Äã](${p.img || ''})\`\`\`ansi
[1;33müìú CHARACTER DOSSIER: ${p.name.toUpperCase()}[0m
[1;30m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[0m
[1;37mSTATUS:[0m    üìç [1;32m${p.status || 'Resting'}[0m
[1;37mRANK:[0m       [1;34m${r.hierarchy}[0m | [1;34m${r.title}[0m
[1;37mPLAYSTYLE:[0m [1;36m${p.playstyle}[0m | [1;37mLEVEL:[0m [1;33m${p.level}[0m
[1;37mIDENTITY:[0m  [1;35m${p.race} ${p.class}[0m
[1;37mHOME:[0m       [1;30m${p.address || 'Traveler'}[0m

[1;33m‚öîÔ∏è CORE ATTRIBUTES[0m
[1;31m[MGT][0m [1;37m${(s.MGT || 0).toString().padEnd(3)}[0m [1;30m[[0m[1;31m${getBar(s.MGT)}[1;30m][0m    [1;32m[AGI][0m [1;37m${(s.AGI || 0).toString().padEnd(3)}[0m [1;30m[[0m[1;32m${getBar(s.AGI)}[1;30m][0m
[1;34m[VIT][0m [1;37m${(s.VIT || 0).toString().padEnd(3)}[0m [1;30m[[0m[1;34m${getBar(s.VIT)}[1;30m][0m    [1;35m[WIL][0m [1;37m${(s.WIL || 0).toString().padEnd(3)}[0m [1;30m[[0m[1;35m${getBar(s.WIL)}[1;30m][0m
[1;36m[FAT][0m [1;37m${(s.FAT || 0).toString().padEnd(3)}[0m [1;30m[[0m[1;36m${getBar(s.FAT)}[1;30m][0m

[1;33mü§ù ASSIGNED DUTIES[0m
${dutiesList}

[1;33müèπ ACTIVE MISSIONS[0m
${missionsList}

[1;33müìñ HISTORY[0m
[1;37m${historySnippet}[0m
[1;30m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[0m
[1;33m*Recorded in the Scholar's Journal*[0m
\`\`\``;
    openModal("üì¢ Character Dossier Card", "Copy and paste into Discord.", card);
  }

  function prepareVisualArtifact() {
    const p = data.profile;
    let powerLevel = p.level > 50 ? "legendary and battle-hardened" : "adventurous";
    let styleFocus = p.playstyle === "Crafter" ? "holding tools of the trade," : "ready for combat,";
    const bioSnippet = p.bio ? p.bio.substring(0, 120).replace(/\n/g, ' ') : "";
    const prompt = `(Cinematic photorealistic portrait of ${p.name}, ${p.fullTitle || p.race + ' ' + p.class}): A ${powerLevel} ${p.race} ${p.class} ${styleFocus} wearing highly detailed ${p.theme.replace('theme-', '')}-style traditional LOTR armor and travel-worn leather gear. Background: A breathtaking vista of ${p.theme.replace('theme-', ' ')} during the Third Age, volumetric lighting, dramatic shadows. Character Details: ${bioSnippet}. Technical: 8k resolution, Unreal Engine 5 render, intricately detailed textures, masterpiece, hyper-realistic, Middle-earth aesthetic, Weta Workshop style.`.trim().replace(/\s\s+/g, ' ');
    openModal("‚ú® Summon Illustrator", "Paste this into an AI generator:", prompt);
  }

  function generateShareLink() {
    const url = window.location.origin + window.location.pathname + "?mode=display&view=" + encodeURIComponent(btoa(JSON.stringify(data))); 
    openModal("üîó Share Journal", "Send this link for the clean 'Reader' view:", url);
  }

  function save() { if (isSharedView) return; localStorage.setItem(DB_KEY, JSON.stringify(data)); render(); notifySave(); }
  function notifySave() { const t = document.getElementById('save-toast'); t.classList.add('show'); setTimeout(() => { t.classList.remove('show'); }, 2000); }
  function toggleMedal(id) { if(!data.war.medals) data.war.medals = []; const i = data.war.medals.indexOf(id); if(i>-1) data.war.medals.splice(i,1); else data.war.medals.push(id); save(); }
  function toggleVirtue(v) { if(!data.virtues) data.virtues = []; const i = data.virtues.indexOf(v); if(i>-1) data.virtues.splice(i,1); else data.virtues.push(v); save(); }
  function addGalleryImg() { const u = document.getElementById('g-url'); if(u.value){ if(!data.gallery) data.gallery=[]; data.gallery.unshift(u.value); u.value=''; save(); } }
  function modStat(s,v) { data.stats[s] = (data.stats[s] || 0) + v; save(); }
  function directUpdateStat(s, v) { data.stats[s] = parseInt(v) || 0; save(); }
  function updateChar(k,v) { data.profile[k]=v; save(); }
  function updateWar(k,v) { if(!data.war) data.war={}; data.war[k]=v; save(); }
  function updateRole(k,v) { data.role[k]=v; save(); }
  function addDuty() { const i = document.getElementById('new-duty'); if(i.value){data.role.duties.push(i.value); i.value=''; save();}}
  function addMission() { const t = document.getElementById('m-title'), d = document.getElementById('m-desc'); if(t.value){data.missions.unshift({t:t.value,d:d.value,s:'OPEN'}); t.value=''; d.value=''; save();}}
  function addItem() { const n = document.getElementById('v-name'), s = document.getElementById('v-stats'), r = document.getElementById('v-rarity'); if(n.value){data.vault.push({n:n.value,s:s.value, r:r.value}); n.value=''; s.value=''; save();}}
  function addKin() { const n = document.getElementById('k-name'), r = document.getElementById('k-role'); if(n.value){data.kinship.push({n:n.value,r:r.value}); n.value=''; r.value=''; save();}}
  function addChronicle() { const t = document.getElementById('c-text'), type = document.getElementById('c-type'); if(t.value){data.chronicle.unshift({d:new Date().toLocaleDateString(),t:t.value, type: type.value}); t.value=''; save();}}
  function updateTheme(val) { data.profile.theme = val; document.body.className = val; save(); }
  function showPanel(id, b) { document.querySelectorAll('.panel, .nav-link').forEach(x=>x.classList.remove('active')); document.getElementById(id).classList.add('active'); b.classList.add('active'); }
  function openModal(t, s, c) { document.getElementById('modal-title').innerText = t; document.getElementById('modal-sub').innerText = s; document.getElementById('discord-out').value = c; document.getElementById('modal').style.display = 'flex'; }
  function copyDiscordCard() { document.getElementById('discord-out').select(); document.execCommand('copy'); alert("Copied to clipboard!"); }
  function closeModal() { document.getElementById('modal').style.display='none'; }
  function exportData() { const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`archive_${data.profile.name}.json`; a.click(); }
  function importData(e) { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const imported = JSON.parse(event.target.result); if (imported.profile) { data = imported; save(); location.reload(); } } catch(err) { alert("Invalid JSON file."); } }; reader.readAsText(file); }
  function resetData() { if(confirm("Erase all data?")) { localStorage.clear(); location.reload(); } }

  init();
</script>
</body>
</html>